---
// Import necessary components and movie data
import Section from '../../ui/Section.astro'
import Row from '../../ui/Row.astro'
import Col from '../../ui/Col.astro'
import moviesData from './favoriteMovies.json'

// Extract unique genres from moviesData
const uniqueGenres = Array.from(new Set(moviesData.flatMap((movie) => movie.genres)))

// Extract unique languages and check if dubbing information is available
const uniqueLanguages = Array.from(new Set(moviesData.map((movie) => movie.originalLanguage)))
const hasDubbedMovies = moviesData.some((movie) => movie.dubbedInEnglish === 'yes')
---

<Section id="intro" padding="top" classes="bg-neutral-50 dark:bg-neutral-900 pb-10">
	<Row>
		<Col span="2" />
		<Col span="8" align="center">
			<h1>My <strong>Favorite Movies</strong> Ranked</h1>
			<p class="white mb-0 pb-0 text-lg">Filter by Genre(s)</p>
			<p class="pb-0 text-sm">
				(When multiple genres are selected it will only show movies with all of the selected genres)
			</p>

			<!-- Genre Filters -->
			<div class="genre-filters">
				{
					uniqueGenres.map((genre) => (
						<label>
							<input
								type="checkbox"
								value={genre}
								class="genre-checkbox"
								aria-label={`Filter by ${genre}`}
							/>
							{genre}
						</label>
					))
				}

				<!-- Dubbed in English Filter -->
				{
					hasDubbedMovies && (
						<div class="filter-section pt-5">
							<label for="dubbedFilter" class="filter-label">
								Dubbed in English:
							</label>
							<select id="dubbedFilter">
								<option value="">All</option>
								<option value="yes">Yes</option>
								<option value="no">No</option>
							</select>
						</div>
					)
				}

				<!-- Language Filter -->
				<div class="filter-section">
					<label for="languageFilter" class="filter-label">Original Language:</label>
					<select id="languageFilter">
						<option value="">All Languages</option>
						{uniqueLanguages.map((language) => <option value={language}>{language}</option>)}
					</select>
				</div>

				<p class="white mt-10 pb-0 text-lg">Starting with the best...</p>
			</div>

			<div class="movie-grid">
				{
					moviesData.map((movie, index) => (
						<div
							class="movie-wrapper"
							data-genres={movie.genres.join(', ')}
							data-language={movie.originalLanguage}
							data-dubbed={movie.dubbedInEnglish}
						>
							<div class="number">#{index + 1}</div>
							<div class="movie-card" data-expanded="false">
								<div class="movie-content">
									<a href={movie.pageUrl} target="_blank" class="movie-link">
										<h2 class="movie-title">{movie.title}</h2>
									</a>
									<div class="movie-year">{movie.year}</div>
									<div class="movie-genres">{movie.genres ? movie.genres.join(', ') : 'N/A'}</div>
									<a href={movie.pageUrl} target="_blank" class="movie-link">
										<img src={movie.imageUrl} alt={movie.title} class="movie-cover" />
									</a>
									<p class="movie-description collapsed">{movie.description}</p>
									<button class="expand-button" style="display: none;">
										Expand
									</button>
								</div>
							</div>
						</div>
					))
				}
			</div>
		</Col>
	</Row>

	<script>
		document.addEventListener('DOMContentLoaded', () => {
			const cards = document.querySelectorAll('.movie-card')
			const genreCheckboxes = document.querySelectorAll('.genre-checkbox')
			const languageFilter = document.getElementById('languageFilter')
			const dubbedFilter = document.getElementById('dubbedFilter')

			const filterMovies = () => {
				const selectedGenres = Array.from(genreCheckboxes)
					.filter((checkbox) => (checkbox as HTMLInputElement).checked)
					.map((checkbox) => (checkbox as HTMLInputElement).value)
				const selectedLanguage = languageFilter ? (languageFilter as HTMLSelectElement).value : ''
				const selectedDubbed = dubbedFilter ? (dubbedFilter as HTMLSelectElement).value : ''

				cards.forEach((card) => {
					const movieWrapper = card.closest('.movie-wrapper') as HTMLElement
					if (!movieWrapper) return // Safety check

					const movieGenres = movieWrapper.getAttribute('data-genres')?.split(', ') || []
					const movieLanguage = movieWrapper.getAttribute('data-language')
					const movieDubbed = movieWrapper.getAttribute('data-dubbed')

					const matchesGenres =
						selectedGenres.length === 0 ||
						selectedGenres.every((genre) => movieGenres.includes(genre))
					const matchesLanguage = !selectedLanguage || movieLanguage === selectedLanguage
					const matchesDubbed = !selectedDubbed || movieDubbed === selectedDubbed

					const isVisible = matchesGenres && matchesLanguage && matchesDubbed
					movieWrapper.style.display = isVisible ? 'block' : 'none'
				})
			}

			// Event listeners for genre checkboxes, language, and dubbed filters
			genreCheckboxes.forEach((checkbox) => checkbox.addEventListener('change', filterMovies))
			if (languageFilter) languageFilter.addEventListener('change', filterMovies)
			if (dubbedFilter) dubbedFilter.addEventListener('change', filterMovies)
		})
	</script>
</Section>

<style>
	/* Flexbox grid for movie cards */
	.movie-grid {
		display: flex;
		flex-wrap: wrap;
		justify-content: center;
		gap: 20px;
		padding: 20px 0;
	}
	.movie-card {
		background-color: #fff;
		border-radius: 10px;
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		overflow: hidden;
		width: 310px;
		height: 655px;
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 15px;
		position: relative;
		transition: box-shadow 0.2s ease;
	}
	.movie-card:hover {
		box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
	}
	.movie-wrapper {
		position: relative;
	}
	.number {
		font-size: 1rem;
		color: #fff;
		position: absolute;
		top: -12px;
		left: -10px;
		background-color: #e2187d;
		border-radius: 5px;
		padding: 0px 5px;
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		z-index: 10;
	}
	.movie-content {
		text-align: center;
	}
	.movie-cover {
		width: 100%;
		height: auto;
		border-radius: 8px;
		transition:
			transform 0.3s ease,
			filter 0.3s ease;
		margin-top: 15px;
	}
	.movie-cover:hover {
		filter: brightness(1.1);
	}
	.movie-title {
		margin-top: 0px;
		margin-bottom: 0px;
		font-size: 1.25rem;
		color: #e2187d;
		font-weight: bold;
		transition: color 0.2s ease;
	}
	.movie-title:hover {
		text-decoration: underline;
		color: #c4166b;
	}
	.movie-description {
		margin-top: 10px;
		margin-bottom: 5px;
		font-size: 0.9rem;
		color: #666;
		overflow: hidden;
		transition: max-height 0.3s ease;
		display: -webkit-box;
		-webkit-line-clamp: var(--line-clamp, 5);
		-webkit-box-orient: vertical;
	}
	.movie-description.collapsed {
		overflow: hidden;
		max-height: calc(var(--line-clamp, 5) * 1.2em);
	}
	.movie-description.expanded {
		overflow: visible;
		-webkit-line-clamp: none;
		-webkit-box-orient: unset;
		max-height: none;
	}
	.expand-button {
		background-color: transparent;
		border: none;
		color: #e2187d;
		cursor: pointer;
		font-size: 0.9rem;
		margin-top: 0px;
		width: -webkit-fill-available;
		transition: color 0.2s ease;
	}
	.expand-button:hover {
		text-decoration: underline;
		color: #c4166b;
	}

	/* Add styles for genre filter */
	#genre-filter {
		margin-bottom: 20px;
		text-align: center;
	}
	#checkboxes {
		display: flex;
		flex-wrap: wrap;
		justify-content: center;
		gap: 15px;
		margin-top: 10px;
	}
	.genre-checkbox {
		cursor: pointer;
	}
	.genre-filters > label {
		margin-right: 15px;
	}

	.movie-genres {
		font-size: 0.6rem;
		overflow-x: hidden;
		width: 100%;
		white-space: nowrap;
	}

	.white {
		color: white;
	}
</style>
